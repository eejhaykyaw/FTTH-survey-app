<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTA Survey App</title>
  <style>
    body { font-family: Arial; margin: 0; padding: 0; }
    #map { height: 300px; width: 100%; }
    video, canvas { width: 100%; max-height: 300px; }
    .section { padding: 10px; }

button { font-size: 18px; padding: 12px; border-radius: 6px; }

.buttons button { margin: 8px 0; width: 100%; }

    .zoom-slider { width: 100%; }
  </style>
</head>
<body>
  <div class="section">
    <h2>FTTH Survey App</h2>
    <div id="map"></div>
    <button onclick="getCurrentLocation()">üìç Use Current Location</button>
    <input id="latitude" placeholder="Latitude" />
    <input id="longitude" placeholder="Longitude" />
    <input id="poletag" placeholder="Name or Pole Tag" />
    <input id="description" placeholder="Description or Remarks" />
  </div>
  <div class="section">
    <video id="camera" autoplay muted playsinline></video>
    <input type="range" id="zoomSlider" class="zoom-slider" min="1" max="3" step="0.1">
    <div class="buttons">
      <button onclick="startCamera()">Start Camera</button>
      <button onclick="captureImage('Whole')">üì∏ Whole</button>
      <button onclick="captureImage('Cable Attachment')">üì∏ Cable Attachment</button>
      <button onclick="captureImage('Pole Tag')">üì∏ Pole Tag</button>
      <button onclick="captureImage('Additional')">üì∏ Additional</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="imagePreview"></div>
  </div>
  <div class="section">
    <button onclick="nextEntry()">‚ûï Next Entry</button>
    <button onclick="exportData()">üíæ Export CSV + Images</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <script>
    let map = L.map('map').setView([14.5995, 120.9842], 13);
    let marker = null;
    let entries = [];
    let images = [];

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data ¬© <a href="https://openstreetmap.org">OpenStreetMap</a>'
    }).addTo(map);

    map.on('click', function(e) {
      if (images.length === 0) {
        const { lat, lng } = e.latlng;
        setMarker(lat, lng);
      }
    });

    function setMarker(lat, lng) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById("latitude").value = lat.toFixed(6);
      document.getElementById("longitude").value = lng.toFixed(6);
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        setMarker(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 18);
      });
    }

    let cameraStream;
    async function startCamera() {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById("camera");
      video.srcObject = cameraStream;

      const [track] = cameraStream.getVideoTracks();
      const capabilities = track.getCapabilities();
      const zoomSlider = document.getElementById("zoomSlider");

      if (capabilities.zoom) {
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
        zoomSlider.oninput = () => track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
      }
    }

    async function captureImage(label) {
      const canvas = document.getElementById("canvas");
      const video = document.getElementById("camera");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;
      const address = marker ? marker.getLatLng().toString() : "Unknown";

      const ts = new Date().toLocaleString();
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText(`üìç ${address}`, 10, canvas.height - 60);
      ctx.fillText(`‚è±Ô∏è ${ts}`, 10, canvas.height - 40);
      ctx.fillText(`üìå ${lat}, ${lng}`, 10, canvas.height - 20);

      canvas.toBlob(blob => {
        const poletag = document.getElementById("poletag").value || "Entry";
        const filename = `${poletag}_${label.replace(" ", "_")}.jpg`;
        images.push({ name: filename, blob });
        const img = document.createElement("img");
        img.src = URL.createObjectURL(blob);
        img.width = 100;
        document.getElementById("imagePreview").appendChild(img);
      }, "image/jpeg");
    }

    function nextEntry() {
      const poletag = document.getElementById("poletag").value || "Entry";
      const remarks = document.getElementById("description").value || "";
      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;
      entries.push({ poletag, remarks, lat, lng, images: [...images] });
      images = [];
      document.getElementById("imagePreview").innerHTML = "";
      document.getElementById("poletag").value = "";
      document.getElementById("description").value = "";
    }

    async function exportData() {
      const zip = new JSZip();
      const csv = ["Name,Description,Latitude,Longitude"];

      for (let entry of entries) {
        csv.push(`${entry.poletag},${entry.remarks},${entry.lat},${entry.lng}`);
        const folder = zip.folder(entry.poletag);
        for (let img of entry.images) {
          folder.file(img.name, img.blob);
        }
      }

      zip.file("summary.csv", csv.join("\n"));
      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "FTTH_Survey_Export.zip";
      link.click();
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<footer style="text-align: center; font-size: 0.9em; color: #777; padding: 1em 0;">
  Built for fiber techs. Powered by OpenAI √ó GitHub.<br>
  Pole RTA survey App. ¬© 2025 Erfe Jr Quiao. All rights reserved.

</body>
</html>
