<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTTH Survey App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    #map { height: 300px; margin-bottom: 10px; }
    video { width: 100%; height: auto; }
    canvas { display: none; }
    input, button, select, textarea { margin: 5px 0; padding: 8px; width: 100%; max-width: 500px; }
    .photo-label { font-weight: bold; margin-top: 10px; }
  </style>
  <script src="https://unpkg.com/idb@7/build/iife/index-min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <h1>FTTH Survey App</h1>

  <div id="map"></div>
  <button onclick="getCurrentLocation()">üìç Use Current Location</button>
  <input id="latitude" placeholder="Latitude" />
  <input id="longitude" placeholder="Longitude" />

  <input id="poletag" placeholder="Name or Poletag (required)" />
  <textarea id="description" placeholder="Remarks / Description"></textarea>

  <div id="camera-container">
    <video id="camera" autoplay muted playsinline></video>
    <button onclick="captureImage()">üì∏ Capture</button>
  </div>
  <canvas id="canvas"></canvas>

  <div id="labels">
    <div class="photo-label">1. Whole</div>
    <div class="photo-label">2. Cable Attachment</div>
    <div class="photo-label">3. Pole Tag</div>
    <div class="photo-label">4. Additional (optional)</div>
  </div>

  <button onclick="nextEntry()">‚ûï Next Entry</button>
  <button onclick="exportZip()">üíæ Export as ZIP</button>

  <script>
    let map, marker, currentCoords = {}, db, mediaStream;
    let entries = [];
    let images = [];
    const photoTypes = ['Whole', 'Cable_Attachment', 'Poletag', 'Additional'];
    let currentPhotoIndex = 0;

    async function initMap() {
      map = L.map('map').setView([14.5995, 120.9842], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      map.on('click', e => setCoords(e.latlng.lat, e.latlng.lng));
    }

    function setCoords(lat, lng) {
      currentCoords = { lat, lng };
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        setCoords(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 18);
      });
    }

    async function startCamera() {
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      document.getElementById('camera').srcObject = mediaStream;
    }

    function captureImage() {
      if (!mediaStream) return alert('Camera not started');
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('camera');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      embedAndStore(canvas);
    }

    async function embedAndStore(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      const ts = new Date().toLocaleString();
      const coordsText = `Lat: ${currentCoords.lat?.toFixed(5)}, Lng: ${currentCoords.lng?.toFixed(5)}`;
      ctx.fillText(ts, 10, 30);
      ctx.fillText(coordsText, 10, 60);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
      const poletag = document.getElementById('poletag').value.trim().replaceAll(' ', '_');
      const label = photoTypes[currentPhotoIndex];
      images.push({
        folder: poletag,
        filename: `${poletag}_${label}.jpg`,
        blob
      });
      currentPhotoIndex++;

      if (currentPhotoIndex >= photoTypes.length) {
        alert('All images captured');
      } else {
        alert(`Next: ${photoTypes[currentPhotoIndex]}`);
      }
    }

    function nextEntry() {
      const poletag = document.getElementById('poletag').value.trim();
      const description = document.getElementById('description').value.trim();
      const lat = document.getElementById('latitude').value;
      const lng = document.getElementById('longitude').value;

      if (!poletag || !lat || !lng || images.length < 3) {
        alert('Missing data or images. Capture at least 3 photos.');
        return;
      }

      entries.push({
        poletag,
        description,
        latitude: lat,
        longitude: lng,
        timestamp: new Date().toISOString()
      });
      currentPhotoIndex = 0;
      images = [];
      document.getElementById('poletag').value = '';
      document.getElementById('description').value = '';
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      if (marker) map.removeLayer(marker);
      alert('Entry saved. Ready for next.');
    }

    async function exportZip() {
      const zip = new JSZip();
      const csvLines = ['Poletag,Description,Latitude,Longitude,Timestamp'];
      entries.forEach(entry => {
        csvLines.push(`${entry.poletag},"${entry.description}",${entry.latitude},${entry.longitude},${entry.timestamp}`);
      });
      zip.file('summary.csv', csvLines.join('\n'));

      for (const entry of entries) {
        const folder = zip.folder(entry.poletag);
        for (const img of images.filter(i => i.folder === entry.poletag)) {
          folder.file(img.filename, img.blob);
        }
      }
      const content = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = 'FTTH-survey-data.zip';
      a.click();
    }

    window.onload = () => {
      initMap();
      startCamera();
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
