<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTTH Survey App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    #map { height: 300px; margin-bottom: 1rem; }
    .photo-label { margin-top: 0.5rem; font-weight: bold; }
    .preview-img { max-width: 100%; height: auto; margin: 5px 0; }
    .entry-section { border-top: 1px solid #ccc; padding-top: 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>FTTH Survey Logger</h2>

  <label for="entryName">Name or PoleTag (Folder Name):</label><br />
  <input type="text" id="entryName" placeholder="e.g. Pole123" required /><br /><br />

  <label for="entryRemarks">Description or Remarks:</label><br />
  <textarea id="entryRemarks" rows="2" placeholder="Enter additional notes..."></textarea><br /><br />

  <div id="map"></div>
  <button onclick="getCurrentLocation()">Use Current Location</button>
  <button onclick="enableMapClick()">Place Pin Manually</button>

  <div class="entry-section">
    <div class="photo-label">1. Whole</div>
    <button onclick="capturePhoto('Whole')">Take Photo</button>
    <img id="preview-Whole" class="preview-img" />

    <div class="photo-label">2. Cable Attachment</div>
    <button onclick="capturePhoto('CableAttachment')">Take Photo</button>
    <img id="preview-CableAttachment" class="preview-img" />

    <div class="photo-label">3. Pole Tag</div>
    <button onclick="capturePhoto('PoleTag')">Take Photo</button>
    <img id="preview-PoleTag" class="preview-img" />

    <div class="photo-label">4. Additional (optional)</div>
    <button onclick="capturePhoto('Additional')">Take Photo</button>
    <img id="preview-Additional" class="preview-img" />
  </div>

  <button onclick="saveEntry()">Next Entry</button>
  <button onclick="exportAll()">Export All (ZIP)</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <script>
    let map = L.map('map').setView([14.5995, 120.9842], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let marker = null;
    let entries = [];
    let images = {};
    let activeStream = null;

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        setMarker(latitude, longitude);
      });
    }

    function enableMapClick() {
      map.once('click', e => {
        const { lat, lng } = e.latlng;
        setMarker(lat, lng);
      });
    }

    function setMarker(lat, lng) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(`Pinned: ${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();
      map.setView([lat, lng], 17);
    }

    async function capturePhoto(label) {
      const constraints = {
        video: {
          facingMode: 'environment',
          zoom: true
        },
        audio: false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      activeStream = stream;
      const video = document.createElement('video');
      video.srcObject = stream;
      await video.play();

      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.zoom) {
        const zoom = prompt("Zoom level (min: " + capabilities.zoom.min + ", max: " + capabilities.zoom.max + "):", capabilities.zoom.min);
        if (zoom) track.applyConstraints({ advanced: [{ zoom: parseFloat(zoom) }] });
      }

      setTimeout(() => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        const timestamp = new Date().toISOString();
        const coords = marker ? marker.getLatLng() : { lat: 0, lng: 0 };
        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.fillText(`${timestamp}`, 10, 30);
        ctx.fillText(`Lat: ${coords.lat.toFixed(5)} Lng: ${coords.lng.toFixed(5)}`, 10, 60);

        const dataUrl = canvas.toDataURL('image/jpeg');
        document.getElementById(`preview-${label}`).src = dataUrl;
        images[label] = dataUrl;

        video.pause();
        track.stop();
      }, 1000);
    }

    function saveEntry() {
      const name = document.getElementById('entryName').value.trim();
      const remarks = document.getElementById('entryRemarks').value.trim();
      if (!name) return alert("Enter name or poletag");
      if (!marker) return alert("Please place a pin on the map");

      const { lat, lng } = marker.getLatLng();
      const entry = {
        name,
        remarks,
        lat,
        lng,
        images: { ...images }
      };
      entries.push(entry);
      images = {};

      document.querySelectorAll('img').forEach(img => (img.src = ''));
      document.getElementById('entryName').value = '';
      document.getElementById('entryRemarks').value = '';
      if (marker) map.removeLayer(marker);
      marker = null;

      alert("Entry saved. Ready for next.");
    }

    async function exportAll() {
      const zip = new JSZip();
      const csvRows = ["Name,Latitude,Longitude,Remarks"];
      for (const entry of entries) {
        const folder = zip.folder(entry.name);
        csvRows.push(`${entry.name},${entry.lat},${entry.lng},"${entry.remarks}"`);
        for (const [label, dataUrl] of Object.entries(entry.images)) {
          const base64 = dataUrl.split(',')[1];
          folder.file(`${entry.name}_${label}.jpg`, base64, { base64: true });
        }
      }
      zip.file("summary.csv", csvRows.join("\n"));
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "survey_export.zip");
    }
  </script>
</body>
</html>
