<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fiber Survey App</title>
  <style>
    #map { height: 300px; width: 100%; margin-bottom: 10px; }
    video { width: 100%; max-height: 300px; }
    canvas { display: none; }
    .hidden { display: none; }
    .photo-label { font-weight: bold; margin-top: 10px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
  <h2>Fiber Survey App</h2>

  <label>Poletag / Name:</label><br>
  <input type="text" id="poletag" placeholder="e.g., Pole123" required><br><br>

  <label>Description / Remarks:</label><br>
  <textarea id="description" placeholder="e.g., Near transformer" rows="2"></textarea><br><br>

  <div id="map"></div>
  <button id="getLocation">Use My Current Location</button><br><br>
  <label>Latitude:</label> <input type="text" id="lat" />
  <label>Longitude:</label> <input type="text" id="lng" /><br><br>

  <button id="startCamera">Turn On Camera</button>
  <div id="cameraControls" class="hidden">
    <video id="video" autoplay playsinline></video>
    <label for="zoomSlider">Zoom:</label>
    <input type="range" id="zoomSlider" min="1" max="3" step="0.1" />
    <br><br>
    <button id="capturePhoto">üì∏ Capture Photo</button>
    <p class="photo-label" id="photoLabel"></p>
  </div>

  <canvas id="canvas"></canvas>
  <br><br>
  <button id="exportData">‚¨áÔ∏è Export CSV + Images (ZIP)</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script>
    let map, marker, cameraStream, capturedPhotos = [], photoCount = 0;
    let latInput = document.getElementById('lat');
    let lngInput = document.getElementById('lng');
    let coordsLocked = false;

    // Initialize Leaflet Map
    map = L.map('map').setView([14.5995, 120.9842], 13); // default to Manila
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
    updateLatLng(marker.getLatLng());

    marker.on('dragend', () => {
      if (!coordsLocked) updateLatLng(marker.getLatLng());
    });

    function updateLatLng(latlng) {
      latInput.value = latlng.lat.toFixed(6);
      lngInput.value = latlng.lng.toFixed(6);
    }

    map.on('click', function(e) {
      if (!coordsLocked) {
        marker.setLatLng(e.latlng);
        updateLatLng(e.latlng);
      }
    });

    document.getElementById('getLocation').addEventListener('click', () => {
      if (!navigator.geolocation) return alert("Geolocation not supported.");
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        marker.setLatLng([latitude, longitude]);
        map.setView([latitude, longitude], 17);
        updateLatLng({ lat: latitude, lng: longitude });
      });
    });

    document.getElementById('startCamera').addEventListener('click', async () => {
      const video = document.getElementById('video');
      const zoomSlider = document.getElementById('zoomSlider');
      const cameraControls = document.getElementById('cameraControls');

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = cameraStream;
        cameraControls.classList.remove('hidden');

        const [track] = cameraStream.getVideoTracks();
        const capabilities = track.getCapabilities();
        if ('zoom' in capabilities) {
          zoomSlider.min = capabilities.zoom.min || 1;
          zoomSlider.max = capabilities.zoom.max || 3;
          zoomSlider.step = capabilities.zoom.step || 0.1;
          zoomSlider.value = track.getSettings().zoom || 1;
          zoomSlider.addEventListener('input', () => {
            track.applyConstraints({ advanced: [{ zoom: parseFloat(zoomSlider.value) }] });
          });
        }
      } catch (e) {
        alert("Camera error: " + e);
      }
    });

    document.getElementById('capturePhoto').addEventListener('click', () => {
      const poletag = document.getElementById('poletag').value.trim();
      if (!poletag) return alert("Please enter a name or poletag.");
      if (!coordsLocked) coordsLocked = true;

      const description = document.getElementById('description').value.trim();
      const lat = latInput.value;
      const lng = lngInput.value;

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const label = ["Whole", "Cable", "PoleTag", "Additional"][photoCount] || `Photo${photoCount+1}`;
      const fileName = `${poletag}_${label}.jpg`;

      const overlayText = `${fileName}\n${lat}, ${lng}\n${timestamp}`;
      ctx.fillStyle = "white";
      ctx.font = "30px sans-serif";
      ctx.fillText(overlayText, 20, 40);

      canvas.toBlob(blob => {
        capturedPhotos.push({ blob, fileName, poletag, description, lat, lng });
        photoCount++;
        document.getElementById('photoLabel').innerText = `Saved: ${fileName}`;
      }, 'image/jpeg');
    });

    document.getElementById('exportData').addEventListener('click', () => {
      if (capturedPhotos.length === 0) return alert("No photos captured.");
      const zip = new JSZip();
      const csvRows = [["Poletag", "Description", "Latitude", "Longitude", "Filename"]];

      capturedPhotos.forEach(photo => {
        const folder = zip.folder(photo.poletag);
        folder.file(photo.fileName, photo.blob);
        csvRows.push([photo.poletag, photo.description, photo.lat, photo.lng, photo.fileName]);
      });

      const csvContent = csvRows.map(row => row.join(",")).join("\n");
      zip.file("summary.csv", csvContent);

      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = "fiber_survey.zip";
        a.click();
      });
    });
  </script>
</body>
</html>
