<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTTH Survey App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #map { height: 300px; margin-bottom: 1rem; }
    video, canvas { width: 100%; max-height: 300px; }
    .btn { padding: 0.5rem; margin: 0.25rem; }
    .flex { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .input-row { margin-bottom: 0.5rem; }
    label { display: block; margin-top: 0.5rem; }
    #zoomSlider { width: 100%; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2>FTTH Survey App</h2>

  <div id="map"></div>
  <button onclick="getCurrentLocation()">ğŸ“ Use Current Location</button>

  <div class="input-row">
    <label>Pole Tag / Name:</label>
    <input type="text" id="poletag" />
  </div>

  <div class="input-row">
    <label>Description / Remarks:</label>
    <input type="text" id="description" />
  </div>

  <div class="input-row">
    <label>Coordinates:</label>
    <input type="text" id="latitude" readonly />
    <input type="text" id="longitude" readonly />
  </div>

  <video id="video" autoplay playsinline></video>
  <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1" />

  <div class="flex">
    <button class="btn" onclick="capturePhoto('Whole')">ğŸ“· Whole</button>
    <button class="btn" onclick="capturePhoto('Cable')">ğŸ“· Cable Attachment</button>
    <button class="btn" onclick="capturePhoto('Poletag')">ğŸ“· Pole Tag</button>
    <button class="btn" onclick="capturePhoto('Additional')">ğŸ“· Additional</button>
  </div>

  <div class="flex">
    <button class="btn" onclick="nextEntry()">Next Entry â•</button>
    <button class="btn" onclick="downloadZip()">ğŸ“ Export All Entries</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/iife/index-min.js"></script>

  <script>
    let map, marker, latInput = document.getElementById('latitude'),
        lngInput = document.getElementById('longitude'),
        firstPhotoTaken = false;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
        window.track = stream.getVideoTracks()[0];
      });

    document.getElementById('zoomSlider').addEventListener('input', e => {
      const zoom = e.target.value;
      if (track && track.getCapabilities().zoom) {
        track.applyConstraints({ advanced: [{ zoom }] });
      }
    });

    function initMap() {
      map = L.map('map').setView([14.5995, 120.9842], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      marker = L.marker(map.getCenter(), { draggable: true }).addTo(map)
        .on('drag', updateLatLng);
      updateLatLng();

      map.on('click', e => {
        if (!firstPhotoTaken) {
          marker.setLatLng(e.latlng);
          updateLatLng();
        }
      });
    }

    function updateLatLng() {
      const latlng = marker.getLatLng();
      latInput.value = latlng.lat.toFixed(6);
      lngInput.value = latlng.lng.toFixed(6);
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        if (!firstPhotoTaken) {
          marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude], 17);
          updateLatLng();
        }
      });
    }

    async function capturePhoto(label) {
      if (!document.getElementById('poletag').value.trim()) {
        alert("Enter Pole Tag / Name first.");
        return;
      }

      firstPhotoTaken = true;

      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      const lat = latInput.value;
      const lng = lngInput.value;

      // Get short address
      let address = '';
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
        const data = await response.json();
        address = data.address.road + ', ' + (data.address.suburb || data.address.village || '') + ', ' + data.address.city;
      } catch (e) {}

      // Overlay
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
      ctx.fillStyle = "white";
      ctx.font = "20px sans-serif";
      const time = new Date().toLocaleString();
      ctx.fillText(`ğŸ“ ${lat}, ${lng}`, 10, canvas.height - 50);
      ctx.fillText(`ğŸ•’ ${time}`, 10, canvas.height - 25);
      if (address) ctx.fillText(`ğŸ“Œ ${address}`, 10, canvas.height - 5);

      const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg"));
      const poletag = document.getElementById('poletag').value.trim();
      const filename = `${poletag}_${label}.jpg`;

      entries[currentEntry] = entries[currentEntry] || { images: {}, tag: poletag, desc: document.getElementById('description').value.trim(), lat, lng, timestamp: time };
      entries[currentEntry].images[label] = blob;

      alert(`${label} photo saved.`);
    }

    let entries = {}, currentEntry = 0;

    function nextEntry() {
      if (!entries[currentEntry]) {
        alert("Please capture at least one photo before proceeding.");
        return;
      }
      currentEntry++;
      document.getElementById('poletag').value = '';
      document.getElementById('description').value = '';
      firstPhotoTaken = false;
      alert("Ready for next entry.");
    }

    async function downloadZip() {
      const zip = new JSZip();
      const csv = ["Poletag,Description,Latitude,Longitude,Timestamp"];

      Object.values(entries).forEach(entry => {
        const folder = zip.folder(entry.tag);
        csv.push(`${entry.tag},${entry.desc},${entry.lat},${entry.lng},${entry.timestamp}`);
        for (let [label, blob] of Object.entries(entry.images)) {
          folder.file(`${entry.tag}_${label}.jpg`, blob);
        }
      });

      zip.file("summary.csv", csv.join("\n"));
      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "FTTH_Survey.zip";
      link.click();
    }

    window.onload = initMap;
  </script>
</body>
</html>
