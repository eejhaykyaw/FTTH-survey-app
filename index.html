<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTA Survey App</title>
  <style>
    body { font-family: Arial; margin: 0; padding: 0; }
    #map { height: 300px; width: 100%; }
    video, canvas { width: 100%; max-height: 300px; }
    .section { padding: 10px; }
    button { font-size: 18px; padding: 12px; border-radius: 6px; }
    .buttons button { margin: 8px 0; width: 100%; }
    .zoom-slider { width: 100%; }
  </style>
</head>
<body>
  <div class="section">
    <h2>RTA Survey App</h2>
    <div id="map"></div>
    <button onclick="getCurrentLocation()">ğŸ“ Use Current Location</button>
<!-- Row 1: Lat / Lng -->
<div style="display:flex; gap:10px; justify-content:center; margin:6px 0;">
  <input id="latitude" placeholder="Latitude" style="width:200px; font-size:16px; padding:8px;" />
  <input id="longitude" placeholder="Longitude" style="width:200px; font-size:16px; padding:8px;" />
</div>

<!-- Row 2: Name / Description -->
<div style="display:flex; gap:10px; justify-content:center; margin:6px 0;">
  <input id="poletag" placeholder="Name or Pole Tag" style="width:220px; font-size:16px; padding:8px;" />
  <input id="description" placeholder="Description or Remarks" style="width:320px; font-size:16px; padding:8px;" />
</div><div class="section">
    <video id="camera" autoplay muted playsinline></video>
    <input type="range" id="zoomSlider" class="zoom-slider" min="1" max="3" step="0.1">
    <div class="buttons">
      <button onclick="startCamera()">Start Camera</button>
      <button onclick="captureImage('Whole')">ğŸ“¸ Whole</button>
      <button onclick="captureImage('Cable Attachment')">ğŸ“¸ Cable Attachment</button>
      <button onclick="captureImage('Pole Tag')">ğŸ“¸ Pole Tag</button>
      <button onclick="captureImage('Additional')">ğŸ“¸ Additional</button>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="imagePreview"></div>
  </div>
  <div class="section">
    <button onclick="nextEntry()">â• Next Entry</button>
    <button onclick="exportData()">ğŸ’¾ Export CSV + Images</button>
    <button onclick="clearDB()">ğŸ—‘ï¸ Clear All Data</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // ---------------- MAP ----------------
    let map = L.map('map').setView([14.5995, 120.9842], 13);
    let marker = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a>'
    }).addTo(map);

    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      setMarker(lat, lng);
    });

    function setMarker(lat, lng) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById("latitude").value = lat.toFixed(6);
      document.getElementById("longitude").value = lng.toFixed(6);
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        setMarker(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 18);
      });
    }

    // ---------------- CAMERA ----------------
    let cameraStream;
    async function startCamera() {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById("camera");
      video.srcObject = cameraStream;

      const [track] = cameraStream.getVideoTracks();
      const capabilities = track.getCapabilities();
      const zoomSlider = document.getElementById("zoomSlider");

      if (capabilities.zoom) {
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
        zoomSlider.oninput = () => track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
      }
    }

    async function captureImage(label) {
      const canvas = document.getElementById("canvas");
      const video = document.getElementById("camera");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;
      const poletagValue = document.getElementById("poletag").value || "No Pole Tag";
      const remarks = document.getElementById("description").value || "";

      const ts = new Date().toLocaleString();
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText(`ğŸ“ ${poletagValue}`, 10, canvas.height - 80);
      ctx.fillText(`ğŸ“ ${remarks}`, 10, canvas.height - 60);
      ctx.fillText(`â±ï¸ ${ts}`, 10, canvas.height - 40);
      ctx.fillText(`ğŸ“Œ ${lat}, ${lng}`, 10, canvas.height - 20);

      canvas.toBlob(blob => {
        const filename = `${poletagValue}_${label.replace(" ", "_")}.jpg`;
        const imgObj = { name: filename, blob };
        addImageTemp(imgObj);

        const img = document.createElement("img");
        img.src = URL.createObjectURL(blob);
        img.width = 100;
        document.getElementById("imagePreview").appendChild(img);
      }, "image/jpeg");
    }

    // ---------------- INDEXEDDB ----------------
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("SurveyDB", 1);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("entries")) {
            db.createObjectStore("entries", { keyPath: "id", autoIncrement: true });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e.target.error);
      });
    }

    async function saveEntryToDB(entry) {
      const db = await initDB();
      const tx = db.transaction("entries", "readwrite");
      tx.objectStore("entries").add(entry);
    }

    async function getAllEntries() {
      const db = await initDB();
      return new Promise(resolve => {
        const tx = db.transaction("entries", "readonly");
        const store = tx.objectStore("entries");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
      });
    }

    async function clearDB() {
      const db = await initDB();
      const tx = db.transaction("entries", "readwrite");
      tx.objectStore("entries").clear();
      document.getElementById("imagePreview").innerHTML = "";
      alert("All saved survey data cleared.");
    }

    // ---------------- ENTRY HANDLING ----------------
    let tempImages = [];
    function addImageTemp(img) {
      tempImages.push(img);
    }

    async function nextEntry() {
      const poletag = document.getElementById("poletag").value || "Entry";
      const remarks = document.getElementById("description").value || "";
      const lat = document.getElementById("latitude").value;
      const lng = document.getElementById("longitude").value;

      const entry = { poletag, remarks, lat, lng, images: [...tempImages] };
      await saveEntryToDB(entry);

      tempImages = [];
      document.getElementById("imagePreview").innerHTML = "";
      document.getElementById("poletag").value = "";
      document.getElementById("description").value = "";
    }

    async function exportData() {
      const zip = new JSZip();
      const csv = ["Name,Description,Latitude,Longitude"];

      const entries = await getAllEntries();
      for (let entry of entries) {
        csv.push(`${entry.poletag},${entry.remarks},${entry.lat},${entry.lng}`);
        const folder = zip.folder(entry.poletag);
        for (let img of entry.images) {
          folder.file(img.name, img.blob);
        }
      }

      zip.file("summary.csv", csv.join("\n"));
      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "FTTH_Survey_Export.zip";
      link.click();
    }

    // ---------------- AUTO-LOAD ----------------
    window.onload = async () => {
      const entries = await getAllEntries();
      console.log("Loaded from DB:", entries);
    };
  </script>

  <footer style="text-align: center; font-size: 0.9em; color: #777; padding: 1em 0;">
    Built for fiber techs. Powered by OpenAI Ã— GitHub.<br>
    Pole RTA survey App. Â© 2025 Erfe Jr Quiao. All rights reserved.
  </footer>
</body>
</html>
